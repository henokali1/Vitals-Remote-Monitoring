{% extends 'pages/base.html' %}
{% load static %}
{% block title %}Home{% endblock %}
{% block body %}

<!-- templates/home.html -->
{% if user.is_authenticated %}
<section class="section section-live-data">
  <div class="container">
    <div class="row">
      <div class="col s12 m8 offset-m2 l6 offset-l3">
        <div class="card-panel grey lighten-4 grey-text text-darken-4 z-depth-4">
          <h2 class="center green-text">Live Data</h2>
          <img width="52px" src="{% static 'pages/imgs/heart-beat-logo.png' %}"/> <span id="heart_rate" style="font-size: 50px; padding-left: 20px;"><strong>72 bpm</strong></span><br>
          <img width="52px" src="{% static 'pages/imgs/temp-logo.png' %}"/> <span id="body_temp" style="font-size: 50px; padding-left: 20px;"><strong>37 °C</strong></span>
        </div>
      </div>
    </div>
  </div>
</section>

<div id="chartContainer" style="height: 300px; max-width: 920px; margin: 0px auto;"></div>
{% else %}
  <section class="section section-login">
    <div class="container center">
      <div class="row">
        <div class="col s12 m8 offset-m2 l6 offset-l3">
          <div class="card-panel grey lighten-4 grey-text text-darken-4 z-depth-4">
            <h2 class="center">Remote Monitoring of Vital Signs</h2>
            <h2><a class="btn" href="{% url 'account_login' %}">Log In</a> | <a class="btn" href="{% url 'account_signup' %}">Sign Up</a></h2>
          </div>
        </div>
      </div>
    </div>
  </section>

{% endif %}

<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>

<script>
  lattest_data_url = '/live'
  function executeQuery() {
    $.getJSON( lattest_data_url, function(data) {
            // console.log(data)
            document.getElementById('heart_rate').innerText = `${data['heart_rate']} bpm`
            document.getElementById('body_temp').innerText = `${data['body_temp']}°C`
        })
    setTimeout(executeQuery, 1000); // you could choose not to continue on failure...
  }
  
  $(document).ready(function() {
  // run the first time; all subsequent calls will take care of themselves
  setTimeout(executeQuery, 1000);
  });
</script>

<script>
  var dps = []; // dataPoints
            var instance = (new Date()).getTime();
            var chart = new CanvasJS.Chart("chartContainer", {
                title: {
                    text: "ECG"
                },
                
                axisX: {
                    title: "",
                    // valueFormatString: "hh:mm:ss"
                },

                axisY: {
                    title: "ECG",
                    minimum: 86,
                    maximum: 650
                },
                data: [{
                    type: "spline",
                    // xValueType: "dateTime",
                    dataPoints: dps
                }]
            });

            raw_ecg = `{{ecg}}`.split(',')
            yVal = []
            for (let idx = 0; idx < raw_ecg.length; idx++) {
              yVal.push(parseInt(raw_ecg[idx]));
            }
            var updateInterval = 10;
            // var maxDataLength = yVal.length; // number of dataPoints after which the series shifts
            var maxDataLength =200; // number of dataPoints after which the series shifts
            var time = new Date();
            var updateCount = 0;

            var updateChart = function (count) {

                count = count || 1;

                for (var j = 0; j < count; j++) {
                    time.setSeconds(time.getSeconds() + 1);

                    dps.push({
                        x: time.getTime(),
                        y: yVal[updateCount % yVal.length]
                    });

                    updateCount++;

                    if (dps.length > maxDataLength) {
                        dps.shift();
                    }
                }
                

                chart.render();

            };

            // generates first set of dataPoints
            updateChart(maxDataLength);

            // update chart after specified time.
            setInterval(function () { updateChart();}, updateInterval);
</script>

{% endblock %}